# GID Tool Suite - Graph Definition
# This is the GID graph for the GID tool itself
# Following the "eat your own dog food" principle

# ═══════════════════════════════════════════════════════════════════════════════
# NODES
# ═══════════════════════════════════════════════════════════════════════════════

nodes:
  # ───────────────────────────────────────────────────────────────────────────
  # Features (Domain Layer - Why we do it)
  # ───────────────────────────────────────────────────────────────────────────

  F1-TopDownDesign:
    type: Feature
    description: "User can interactively design a graph from requirements"
    priority: core
    status: draft

  F2-BottomUpExtraction:
    type: Feature
    description: "User can automatically extract a graph from existing code"
    priority: core
    status: draft

  F3-GraphVisualization:
    type: Feature
    description: "User can visualize the dependency graph interactively"
    priority: core
    status: draft

  F4-ProgressTracking:
    type: Feature
    description: "User can see which nodes/edges are implemented"
    priority: core
    status: draft

  F5-ImpactAnalysis:
    type: Feature
    description: "User can query what's affected by changing a component"
    priority: core
    status: draft

  F6-FeatureImplementationQuery:
    type: Feature
    description: "User can query what needs to change for a feature"
    priority: core
    status: draft

  F7-DebugRootCause:
    type: Feature
    description: "User can find common causes when debugging"
    priority: core
    status: draft

  F8-GraphHealthEvaluation:
    type: Feature
    description: "User can evaluate graph quality and find issues"
    priority: core
    status: draft

  F9-ArchitectureEvolution:
    type: Feature
    description: "User can plan refactoring by comparing As-Is vs To-Be"
    priority: supporting
    status: draft

  F10-AIImprovementSuggestions:
    type: Feature
    description: "User can get AI-powered suggestions to improve the graph"
    priority: supporting
    status: draft

  # ───────────────────────────────────────────────────────────────────────────
  # Components - Interface Layer
  # ───────────────────────────────────────────────────────────────────────────

  CLI:
    type: Component
    description: "Command-line interface for all tool functionality (gid design/extract/query/check/serve)"
    layer: interface
    status: draft

  # ───────────────────────────────────────────────────────────────────────────
  # Components - Application Layer
  # ───────────────────────────────────────────────────────────────────────────

  Designer:
    type: Component
    description: "Handles top-down graph design flow with AI-assisted feature decomposition"
    layer: application
    status: draft

  Extractor:
    type: Component
    description: "Handles bottom-up graph extraction from existing code"
    layer: application
    status: draft

  QueryEngine:
    type: Component
    description: "Executes graph queries: impact analysis, dependency lookup, root cause analysis"
    layer: application
    status: draft

  Validator:
    type: Component
    description: "Validates graph against integrity rules, generates health reports"
    layer: application
    status: draft

  EvolutionPlanner:
    type: Component
    description: "Compares As-Is and To-Be graphs, generates migration task lists"
    layer: application
    status: draft

  Visualizer:
    type: Component
    description: "Renders interactive graph visualization using D3.js"
    layer: application
    status: draft

  ProgressTracker:
    type: Component
    description: "Tracks development progress on nodes/edges, calculates completion %"
    layer: application
    status: draft

  AIInferrer:
    type: Component
    description: "Uses AI to infer missing info: descriptions, implements edges, layers"
    layer: application
    status: draft

  # ───────────────────────────────────────────────────────────────────────────
  # Components - Domain Layer (Core)
  # ───────────────────────────────────────────────────────────────────────────

  GraphCore:
    type: Component
    description: "Core graph data structure: Node, Edge, Graph types and basic operations"
    layer: domain
    status: draft

  RuleEngine:
    type: Component
    description: "Defines and executes integrity rules (built-in and custom)"
    layer: domain
    status: draft

  # ───────────────────────────────────────────────────────────────────────────
  # Components - Infrastructure Layer
  # ───────────────────────────────────────────────────────────────────────────

  AIClient:
    type: Component
    description: "Wrapper for AI API (Claude), handles rate limiting and retries"
    layer: infrastructure
    status: draft

  PromptTemplates:
    type: Component
    description: "Stores prompt templates for feature decomposition, component design, etc."
    layer: infrastructure
    status: draft

  CodeAnalyzer:
    type: Component
    description: "Unified interface for code dependency extraction"
    layer: infrastructure
    status: draft

  TypeScriptAnalyzer:
    type: Component
    description: "Extracts dependencies from TypeScript/JavaScript using madge"
    layer: infrastructure
    status: draft

  PythonAnalyzer:
    type: Component
    description: "Extracts dependencies from Python code using pydeps"
    layer: infrastructure
    status: draft

  LSPAnalyzer:
    type: Component
    description: "Universal analyzer using Language Server Protocol"
    layer: infrastructure
    status: draft

  YAMLParser:
    type: Component
    description: "Parses and serializes graph.yml files with schema validation"
    layer: infrastructure
    status: draft

  WebServer:
    type: Component
    description: "Express server for visualization web app"
    layer: infrastructure
    status: draft

  GitIntegration:
    type: Component
    description: "Integrates with git for file detection and change history"
    layer: infrastructure
    status: draft

  # ───────────────────────────────────────────────────────────────────────────
  # Interfaces (API contracts)
  # ───────────────────────────────────────────────────────────────────────────

  QueryAPI:
    type: Interface
    description: "API for graph queries: impact, deps, commonCause, path"
    signature: |
      impact(nodeId: string): ImpactResult
      deps(nodeId: string, depth?: number): DependencyResult
      commonCause(nodeA: string, nodeB: string): CommonCauseResult
      path(from: string, to: string): PathResult

  ValidationAPI:
    type: Interface
    description: "API for graph validation"
    signature: |
      check(graph: Graph, rules?: Rule[]): ValidationResult[]
      healthScore(graph: Graph): HealthScore

  ExtractorAPI:
    type: Interface
    description: "API for code extraction"
    signature: |
      extract(dir: string, options: ExtractOptions): ExtractionResult
      supportedLanguages(): string[]

  # ───────────────────────────────────────────────────────────────────────────
  # Data Models
  # ───────────────────────────────────────────────────────────────────────────

  Graph:
    type: Data
    description: "Core graph data model"
    schema:
      nodes: "Record<string, Node>"
      edges: "Edge[]"

  Node:
    type: Data
    description: "Node data model"
    schema:
      id: string
      type: "Feature | Component | Interface | Data | File | Test"
      description: string
      attributes: "Record<string, unknown>"

  Edge:
    type: Data
    description: "Edge data model"
    schema:
      from: string
      to: string
      relation: "implements | depends_on | calls | reads | writes | tested_by"
      attributes: "Record<string, unknown>"

  Rule:
    type: Data
    description: "Validation rule data model"
    schema:
      name: string
      description: string
      severity: "error | warning | info"
      check: string

  # ───────────────────────────────────────────────────────────────────────────
  # Decisions (Why we designed it this way)
  # ───────────────────────────────────────────────────────────────────────────

  ADR-001-TypeScript:
    type: Decision
    title: "Use TypeScript as primary language"
    status: accepted
    rationale: |
      - Best ecosystem for JS/TS code analysis (madge, ts-morph)
      - Isomorphic: share types between CLI and Web
      - Target users are JS/TS developers
    date: "2025-01-24"

  ADR-002-NoGraphDB:
    type: Decision
    title: "Use YAML files instead of graph database"
    status: accepted
    rationale: |
      - Human-readable and git-friendly
      - Sufficient for <1000 nodes
      - Can migrate to SQLite/Neo4j later if needed
    date: "2025-01-24"

  ADR-003-DualVisualization:
    type: Decision
    title: "Use both Mermaid and D3.js"
    status: accepted
    rationale: |
      - Mermaid: portable CLI output, works in GitHub/docs
      - D3.js: full interactivity for web interface
    date: "2025-01-24"

  ADR-004-CommanderJS:
    type: Decision
    title: "Use Commander.js for CLI framework"
    status: accepted
    rationale: |
      - Largest community, best documentation
      - Simple enough for our needs
      - Proven combination with inquirer for interactive prompts
    date: "2025-01-24"

# ═══════════════════════════════════════════════════════════════════════════════
# EDGES
# ═══════════════════════════════════════════════════════════════════════════════

edges:
  # ───────────────────────────────────────────────────────────────────────────
  # implements (Component → Feature)
  # ───────────────────────────────────────────────────────────────────────────

  - { from: Designer, to: F1-TopDownDesign, relation: implements }
  - { from: Extractor, to: F2-BottomUpExtraction, relation: implements }
  - { from: Visualizer, to: F3-GraphVisualization, relation: implements }
  - { from: ProgressTracker, to: F4-ProgressTracking, relation: implements }
  - { from: QueryEngine, to: F5-ImpactAnalysis, relation: implements }
  - { from: QueryEngine, to: F6-FeatureImplementationQuery, relation: implements }
  - { from: QueryEngine, to: F7-DebugRootCause, relation: implements }
  - { from: Validator, to: F8-GraphHealthEvaluation, relation: implements }
  - { from: EvolutionPlanner, to: F9-ArchitectureEvolution, relation: implements }
  - { from: AIInferrer, to: F10-AIImprovementSuggestions, relation: implements }

  # ───────────────────────────────────────────────────────────────────────────
  # depends_on (Component → Component)
  # ───────────────────────────────────────────────────────────────────────────

  # CLI → Application Layer
  - { from: CLI, to: Designer, relation: depends_on }
  - { from: CLI, to: Extractor, relation: depends_on }
  - { from: CLI, to: QueryEngine, relation: depends_on }
  - { from: CLI, to: Validator, relation: depends_on }
  - { from: CLI, to: Visualizer, relation: depends_on }
  - { from: CLI, to: ProgressTracker, relation: depends_on }
  - { from: CLI, to: EvolutionPlanner, relation: depends_on }

  # Designer dependencies
  - { from: Designer, to: AIClient, relation: depends_on }
  - { from: Designer, to: GraphCore, relation: depends_on }
  - { from: Designer, to: PromptTemplates, relation: depends_on }

  # Extractor dependencies
  - { from: Extractor, to: CodeAnalyzer, relation: depends_on }
  - { from: Extractor, to: AIClient, relation: depends_on }
  - { from: Extractor, to: GraphCore, relation: depends_on }

  # QueryEngine dependencies
  - { from: QueryEngine, to: GraphCore, relation: depends_on }

  # Validator dependencies
  - { from: Validator, to: GraphCore, relation: depends_on }
  - { from: Validator, to: RuleEngine, relation: depends_on }

  # EvolutionPlanner dependencies
  - { from: EvolutionPlanner, to: GraphCore, relation: depends_on }
  - { from: EvolutionPlanner, to: QueryEngine, relation: depends_on }

  # Visualizer dependencies
  - { from: Visualizer, to: GraphCore, relation: depends_on }
  - { from: Visualizer, to: WebServer, relation: depends_on }

  # ProgressTracker dependencies
  - { from: ProgressTracker, to: GraphCore, relation: depends_on }
  - { from: ProgressTracker, to: GitIntegration, relation: depends_on }

  # AIInferrer dependencies
  - { from: AIInferrer, to: AIClient, relation: depends_on }
  - { from: AIInferrer, to: GraphCore, relation: depends_on }

  # Infrastructure dependencies
  - { from: AIClient, to: PromptTemplates, relation: depends_on }
  - { from: CodeAnalyzer, to: TypeScriptAnalyzer, relation: depends_on }
  - { from: CodeAnalyzer, to: PythonAnalyzer, relation: depends_on }
  - { from: CodeAnalyzer, to: LSPAnalyzer, relation: depends_on }
  - { from: GraphCore, to: YAMLParser, relation: depends_on }

  # ───────────────────────────────────────────────────────────────────────────
  # calls (Component → Interface)
  # ───────────────────────────────────────────────────────────────────────────

  - { from: CLI, to: QueryAPI, relation: calls }
  - { from: CLI, to: ValidationAPI, relation: calls }
  - { from: CLI, to: ExtractorAPI, relation: calls }
  - { from: QueryEngine, to: QueryAPI, relation: implements }
  - { from: Validator, to: ValidationAPI, relation: implements }
  - { from: Extractor, to: ExtractorAPI, relation: implements }

  # ───────────────────────────────────────────────────────────────────────────
  # reads/writes (Component → Data)
  # ───────────────────────────────────────────────────────────────────────────

  - { from: GraphCore, to: Graph, relation: reads }
  - { from: GraphCore, to: Graph, relation: writes }
  - { from: GraphCore, to: Node, relation: reads }
  - { from: GraphCore, to: Node, relation: writes }
  - { from: GraphCore, to: Edge, relation: reads }
  - { from: GraphCore, to: Edge, relation: writes }
  - { from: RuleEngine, to: Rule, relation: reads }
  - { from: Validator, to: Rule, relation: reads }

  # ───────────────────────────────────────────────────────────────────────────
  # decided_by (Component → Decision)
  # ───────────────────────────────────────────────────────────────────────────

  # TypeScript decision affects all components
  - { from: CLI, to: ADR-001-TypeScript, relation: decided_by }
  - { from: GraphCore, to: ADR-001-TypeScript, relation: decided_by }
  - { from: TypeScriptAnalyzer, to: ADR-001-TypeScript, relation: decided_by }

  # YAML storage decision
  - { from: YAMLParser, to: ADR-002-NoGraphDB, relation: decided_by }
  - { from: GraphCore, to: ADR-002-NoGraphDB, relation: decided_by }

  # Visualization decisions
  - { from: Visualizer, to: ADR-003-DualVisualization, relation: decided_by }
  - { from: WebServer, to: ADR-003-DualVisualization, relation: decided_by }

  # CLI framework decision
  - { from: CLI, to: ADR-004-CommanderJS, relation: decided_by }

# ═══════════════════════════════════════════════════════════════════════════════
# INTEGRITY RULES
# ═══════════════════════════════════════════════════════════════════════════════

integrity_rules:
  - name: no-circular-dependency
    description: "No circular dependencies allowed in depends_on edges"
    severity: error

  - name: feature-must-have-implementation
    description: "Every Feature must have at least one implementing Component"
    severity: warning

  - name: component-must-have-feature
    description: "Every application-layer Component should implement at least one Feature"
    severity: warning

  - name: layer-dependency-direction
    description: "Dependencies should flow: interface → application → domain → infrastructure"
    severity: warning
    note: "domain can depend on infrastructure for storage"

  - name: high-coupling-warning
    description: "Components with more than 5 dependents need attention"
    severity: warning
    threshold: 5
